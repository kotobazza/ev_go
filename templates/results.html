<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты голосования</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/pages/results.css">
</head>

<body>
    <div class="header">
        <div class="brand">Система EV</div>
        <div class="nav">
            <a href="/user/profile" class="nav-link">Профиль</a>
            <form action="/user/logout" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">Выйти</button>
            </form>
        </div>
    </div>

    <div class="container">
        <h1>Результаты голосования</h1>

        <div class="voting-info">
            <strong>ID голосования:</strong> {{.Voting.ID}} <br />
            <strong>Название голосования:</strong> {{.Voting.Name}} <br />
            <strong>Вопрос:</strong> {{.Voting.Question}} <br />
            <strong>Время начала:</strong> {{.Voting.StartTime}} <br />
            <strong>Время окончания принятия голосов:</strong> {{.Voting.EndTime}} <br />
            <strong>Время аудита:</strong> {{.Voting.AuditTime}} <br />
        </div>

        {{if .Result}}
        <div class="section">
            <h2>Результаты</h2>
            <div class="result">
                <div class="label">Результаты:</div>
                <div class="value">
                    <ul>{{range $key, $value := .Result.ResultedCount}}<li class="value">{{$key}} - {{$value}} (голос)
                        </li>{{end}}</ul>
                </div>
                <div class="label">Результирующая сумма:</div>
                <div class="value">{{.Result.CryptedResult}}</div>
                <div class="label">Создан:</div>
                <div class="value">{{.Result.CreatedAt}}</div>
                <div class="label">Доказательство корректности:</div>
                <div class="value">{{.Result.ResultProof}}</div>
                <div id="result-proof"></div>
            </div>
        </div>
        {{end}}



        <div class="section">
            <h2>Корень дерева хешей</h2>
            <div class="merkle-root">
                <div class="label">Значение корня:</div>
                <div class="value">{{.MerklieRoot.RootValue}}</div>
                <div class="timestamp">Создан: {{.MerklieRoot.CreatedAt}}</div>
            </div>
        </div>

        <div class="section">
            <h2>Зашифрованные голоса</h2>
            {{range .PublicEncryptedVotes}}
            <div class="vote">
                <div class="label">Метка:</div>
                <div class="value">{{.Label}}</div>
                <div class="label">Зашифрованный голос:</div>
                <div class="value">{{.EncryptedVote}}</div>
                <div class="label">Создан:</div>
                <div class="value">{{.CreatedAt}}</div>
                <div class="label">Перемещен:</div>
                <div class="value">{{.MovedIntoAt}}</div>
            </div>
            {{end}}
        </div>


        <script type="module" src="/static/js/verifyable_sum.js"></script>
        <script type="module" src="/static/js/math.js"></script>

        <script type="module">
            import { verifyValue, compute_m_from_proof } from '/static/js/verifyable_sum.js';
            import { modPow, modInverse, base64ToBigInt } from '/static/js/math.js';

            const C = base64ToBigInt("{{.Result.CryptedResult}}");
            const r_prime = base64ToBigInt("{{.Result.ResultProof}}");
            const n = base64ToBigInt("{{.PaillierN}}");
            const m = base64ToBigInt("{{.Result.UnencryptedResult}}")

            console.log(C, r_prime, n, m);

            if (verifyValue(C, r_prime, n) == true) {
                document.getElementById("result-proof").innerHTML = "✅ Доказательство корректности подтверждено";
            } else {
                document.getElementById("result-proof").innerHTML = "❌ Доказательство корректности не подтверждено";
            }
        </script>

</body>

</html>